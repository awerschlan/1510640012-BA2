---
  - name: autotrader role
    debug:
      msg: "Autotrader role"
    tags: debug

  - name: install apache package
    yum:
      name: httpd,openssl
      state: present

  - name: enable httpd service on startup
    systemd:
      name: httpd
      enabled: yes

  - name: copy httpd config
    copy:
      src: files/httpd/
      dest: /etc/httpd/conf.d/
      mode: 0644
      owner: root
    notify:  check apache config

  - name: set periotheus version fact
    set_fact:
      atversion: "{{ ansible_local.pt_version.major }}.{{ ansible_local.pt_version.minor }}.*"
    tags: atpackages

  - name: install autotrader packages
    yum:
      name: "autotrader_core-{{ atversion }},autotrader_lib-{{ atversion }},autotrader_adapter-{{ atversion }},autotrader_guard-{{ atversion }},autotrader_rest-{{ atversion }},autotrader_periotheus-{{ atversion }}"
      state: latest
      enablerepo: vtse-testing,autotrader
    notify: install autotrader processes
    tags: atpackages

  - name: install connection manager packages
    yum:
      name: "epex_conmgr-{{ atversion }}"
      state: latest
      enablerepo: vtse-testing,autotrader
    notify: install autotrader processes
    when: autotrader_exchange == "epex"
    tags: atpackages

  - name: edit system.cfg
    ini_file:
      path: /opt/vtse/neurobase/etc/system.cfg
      section: "{{ item.section }}"
      option: "{{ item.option }}"
      value: "{{ item.value }}"
    with_items:
      - { section: startup.jobs.adapter, option: executable, value: /opt/vtse/bin/python }
      - { section: startup.jobs.adapter, option: cmdline_args, value: /opt/vtse/bin/autotrader_adapter_main.py --nbroot %(startup.virtualenv)s }
      - { section: startup.jobs.autotrader, option: executable, value: /opt/vtse/bin/python }
      - { section: startup.jobs.autotrader, option: cmdline_args, value: /opt/vtse/bin/autotrader_core_main.py --nbroot %(startup.virtualenv)s }
      - { section: startup.jobs.epex_manager, option: executable, value: /opt/vtse/bin/python }
      - { section: startup.jobs.epex_manager, option: cmdline_args, value: /opt/vtse/bin/epex_conmgr_main.py --nbroot %(startup.virtualenv)s }
      - { section: startup.jobs.guard, option: executable, value: /opt/vtse/bin/python }
      - { section: startup.jobs.guard, option: cmdline_args, value: /opt/vtse/bin/autotrader_guard_main.py --nbroot %(startup.virtualenv)s }
      - { section: startup, option: virtualenv, value: /opt/vtse/neurobase }
      - { section: startup, option: cwd, value: "%(virtualenv)s/var/run" }
    notify: entedclient reload
    tags: systemcfg

  - name: create /var/www/html/autotrader_rest directory
    file:
      path: /var/www/html/autotrader_rest
      state: directory
    tags: rest-api

  - name: copy autotrader_rest.wsgi
    copy:
      src: files/autotrader_rest.wsgi
      dest: /var/www/html/autotrader_rest/autotrader_rest.wsgi
      mode: 0644
      owner: root
    notify: check apache config
    tags: rest-api

  - name: create symlink /opt/vtse/bin/autotrader_rest_main.py
    file:
      src: /opt/vtse/bin/autotrader_rest_main.py
      dest: /var/www/html/autotrader_rest/autotrader_rest_main.py
      state: link
      force: yes
    notify: check apache config
    tags: rest-api
